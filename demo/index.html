<!DOCTYPE html>
<html>
<head>
  <meta name="format-detection" content="telephone=no">
  <meta name="msapplication-tap-highlight" content="no">
  <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
  <link rel="stylesheet" type="text/css" href="css/index.css">
  <title>Hello World</title>
</head>
<body>
<div class="app">
  <h1>Apache Cordova</h1>

  <div id="deviceready" class="blink">
    <p class="event listening">Connecting to Device</p>

    <p class="event received">Device is Ready</p>
    <script>
      function feedback(what) {
        document.getElementById("feedback").innerHTML = what;
      }

      window.onerror = function (a, b, c) {
        feedback(a + ", " + b + ", " + c);
      }
    </script>
    <button onclick="sendHeaderMessageImageGlance()">glance: header, message, img</button>
    <br/>
    <button onclick="sendMessageImageGlance()">glance: message, img</button>
    <button onclick="sendImageGlance()">glance: img</button>
    <br/><br/>
    <button onclick="loadMainAppPage()">update app UI</button>
    <br/><br/>

    <div>Feedback from Watch App:</div>
    <div style="font-weight:bold" id="feedback"></div>
    <img id="image" src="" style="max-width: 150px"/>
  </div>
</div>
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript" src="js/index.js"></script>
<script>

  setTimeout(function () {
    feedback(localStorage.getItem("someOption"));
  }, 1000);

  var remoteGET = function () {
    if (localStorage.getItem("origin") != null) {
      return localStorage.getItem("origin");
    } else {
      localStorage.setItem("origin", "Reload for IP");
      var xhr = new XMLHttpRequest();
      xhr.open("GET", 'https://httpbin.org/ip', "false");
      xhr.send();
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          var response = JSON.parse(xhr.responseText);
          ip = response.origin;
          localStorage.setItem("origin", ip);
        }
      };
    }
  };

  // TODO split into onGlanceInit and Update? KISS for now..
  function onGlanceRequestsUpdate() {
    sendHeaderMessageImageGlance();
  }

  function onAppRequestsUpdate() {
    // proof that remote networking works with the app being inactive,
    // but I don't want to wait for it to return before rendering the watch UI (need a fast dev cycle)
    //remoteGET();
    loadMainAppPage();
  }

  function onNotificationSendSuccess(msg) {
    console.log("noti send ok: " + msg);
  }

  function onNotificationSendError(msg) {
    alert("noti send nok: " + msg);
  }

  // TODO convenience methods in the plugin JS API would be nice: applewatch.sendToGlance/AppMain/AppDetail which sets the ID
  function sendImageGlance() {
    var payload = {
      'id': 'Glance',
      'image': {
        'src': 'www/img/logo.png'
      }
    };
    applewatch.sendMessage(payload);
  }

  function sendMessageImageGlance() {
    var payload = {
      'id': 'Glance',
      'label2': {'value': 'Red message, a bit smaller image, no header to allow 3 lines', 'color': '#DD0000'}, // optional, max 2 lines
      'image': {'src': 'www/img/logo.png', 'width': '60'} // optional
    };
    applewatch.sendMessage(payload);
  }

  function sendHeaderMessageImageGlance() {
    var payload = {
      'id': 'Glance',
      'label1': {
        'value': 'A gorgeous blue header',
        'color': '#1884C4',
        'font': { // optional
          'size': 10
        }
      }, // optional, max 1 line -> TODO JS object with color and value attribs?
      'label2': { // optional, max 2 lines
        'value': 'With a white message, served @ ' + new Date(),
        'color': '#FFFFFF',
        'font': {
          'size': 8 // default 12
        }
      }, // optional, max 1 line -> TODO JS object with color and value attribs?
      'image': {'src': 'www/img/logo.png', 'alpha': 0.7} // optional
    };
    applewatch.sendMessage(payload);
  }

  function onMainAppPageButtonPressed() {
    // do some action here, then update the app
    loadMainAppPage();
  }

  function onDetailPageButtonPressed() {
    // do some action here, then update the app
    onAppDetailPageRequestsUpdate('Did action ;)');
  }

  function onSomeOptionSelected(on) {
    localStorage.setItem("someOption", on);
    feedback(on);
  }

  function onVoted(result) {
    if (result.type == "base64img") {
      feedback("vote result:");
      document.getElementById("image").src = result.data;
    } else {
      feedback("vote result: " + result.data);
    }
  }

  var sliderVal = 25;
  function onSliderChanged(val) {
    sliderVal = val;
    feedback("<br/>slider update: " + val);
  }

  function onAppDetailPageRequestsUpdate(fromAction) {
    var d = new Date();
    var payload = {
      'id': 'AppDetail', // mandatory
      'group': { // the page wrapper. the defaults are probably best though
        'cornerRadius':0
      },
      'title': 'Back', // optional, shown in the navbar. Better not to set it if this is shown modally (because the default 'Cancel' is shown briefly first)
      'label1': {
        'value': 'Refreshed @ ' + d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds(),
        'color': '#1884C4',
        'font': { // optional
          'size': 10
        }
      },
      'label2': {
        'value' : fromAction === undefined ? 'Default text :)' : fromAction
      },
      'table': { // this element is superawesome.. it's quite flexible and extendible, but it can't have actions
        'rows': [
          {
            'type': 'ImageLabelRowType', // available types are specified in ObjC
            'group': {
              'backgroundColor':'#1884C4',
              'cornerRadius':8
            },
            'label': {'value':'With image'},
            'image': 'www/img/logo.png' // TODO process in plugin code
          },
          {
            'type': 'ImageLabelRowType',
            'group': {
              'backgroundColor':'#1884C4',
              'cornerRadius':8
            },
            'label': {'value':'2nd, no img'}
          }
        ]
      },
      'actionButton': {
        'title': {
          'value': 'Refresh!',
          'color': '#FFA500',
          'font': {
            'size': 12
          }
        },
        'color': '#1884C4',
        'alpha': 1, // default 1
        'callback': 'onDetailPageButtonPressed'
      },
      'contextMenu': {
        'items': [
          {
            'title': 'Delete',
            'iconNamed': 'trash',
            'callback': 'onContextMenuDelete'
          }
        ]
      }
    };
    // TODO create sendMessageToWatchApp(payload) function
    applewatch.sendMessage(payload);
  }

  function loadMainAppPage() {
    var d = new Date();
    var payload = {
      'id': 'AppMain', // mandatory
      'group': { // the page wrapper. the defaults are probably best
        'backgroundColor':'#1884C4',
        'cornerRadius':0
      },
      'title': 'Demo', // optional
      'label1': {
        'value': 'Blue header label',
        'color': '#1884C4',
        'font': { // optional
          'size': 10
        }
      }, // optional, max 1 line -> TODO JS object with color and value attribs?
      'label2': { // optional, max 2 lines
        'value': 'UI built @ ' + new Date(),
        'color': '#FFFFFF',
        'font': {
          'size': 8 // default 12
        }
      }, // optional, max 1 line -> TODO JS object with color and value attribs?
      'image': { // optional
        'src': 'www/img/logo.png'
      },
      'slider': {
        'steps': 20, // of 100, so each step is 5 in this case
        'value': sliderVal, // of 100, so this is a percentage
        'color': '#FFA500',
        'callback': 'onSliderChanged',
        'hideValue': false // default false, allows to now show the value below the slider
      },
      'switch1': {
        'title': localStorage.getItem("origin"),
        'on': (localStorage.getItem("someOption") == "true"),
        'color': '#CC0000',
        'callback': 'onSomeOptionSelected'
      },
      'switch2': {
        'title': 'Foo?',
        'on': true,
        'color': '#02779E'
      },
      'map': {
        'center' : {
          // Eddy's home
          'lat': 52.1851552,
          'lng': 5.3996181
        },
        // Entire Netherlands
        'zoom' : 4.1, // 0.001 is about streetlevel, 4 fits the entire Netherlands
        'annotations': [ // up to 5 annotations (custom pins), any more are ignored (play with the zoom value to make them all fit)
          {
            'pinColor':'green',
            'lat':52.1851,
            'lng':5.3996
          },
          {
            'pinColor':'red',
            'lat':51.751,
            'lng':8.4
          },
          {
            'pinColor':'purple',
            'lat':50.2251,
            'lng':4.7196
          }
        ]
      },
      // NOTE: switch is not possible because it needs an outlet for the returnvalue.. and those can't be inside repeating elements (rowtype)
      'table': { // this element is superawesomesauce! It's mighty flexible and extendible :)
        'alpha': 1,
        // TODO rename (Selectable)ImageLabelRowType to (Selectable)OneColumnRowType .. and stack everything horizontally
        'rows': [
          /*
           {
           'type' : 'ImageLabelRowType', // available types are specified in ObjC
           'label' : 'With image',
           'image' : 'www/img/logo.png' // TODO process in plugin code
           },
           */
          {
            // interesting doc on selectable items in a row: http://blog.numerousapp.com/2014/12/09/watch-dev-2.html
            'type': 'SelectableImageLabelRowType',
            'label': {
              'value': 'Selectable row, no img',
              'color': '#FFFFFF',
              'font': {
                'size': 10
              }
            }
          },
          {
            'type': 'ImageLabelRowType',
            // wrapping these in a group so its usage and processing is predictable
            'group': {
              'backgroundColor':'#FFFFFF',
              'cornerRadius':16
            },
            'label': {
              'value':'Right img (todo)',
              'color':'#1884C4'
            }
          },
          {
            'type': 'TwoColumnsRowType',
            // TODO or col1 : {}, etc? probably better, so we can reuse the col object (even for the 1 col rows)
            'col1label': {
              'value': '50%',
              'color': '#FFA500',
              'font': {
                'size': 18 // default 12
              }
            },
            'col2label': {
              'value': '12x',
              'color': '#FFFFFF',
              'font': {
                'size': 18 // default 12
              }
            }
          }
        ]
      },
      'actionButton': {
        'x-backgroundColor': '#1884C4',
        'title': {
          'value': 'Refresh',
          'color': '#FFA500',
          'font': {
            'size': 17
          }
        },
        'color': '#FFFFFF',
        'width':80,
        'height':44,
        'alpha': 1, // default 1
        'callback': 'onMainAppPageButtonPressed'
      },
      'userInputButton': {
        'inputMode': 'WKTextInputModeAllowAnimatedEmoji', // WKTextInputModePlain, WKTextInputModeAllowEmoji, WKTextInputModeAllowAnimatedEmoji
        'suggestions': ['foo', 'bar', 'shaz'],
        'width':60,
        'height':30,
        'title': {
          'value': 'Vote',
          'color': '#FFFFFF',
          'font': {
            'size': 12 // default 15
          }
        },
        'backgroundColor': '#CC0000',
        'alpha': 1, // default 1
        'callback': 'onVoted'
      },
      'pushNavButton': {
        'backTitle': 'baaack',
        'title': {
          'value': 'Push nav'
        },
        'backgroundColor': '#FFA500',
        'alpha': 1 // default 1
      },
      'modalNavButton': {
        'closeTitle': 'kloos',
        'title': {
          'value': 'Modal nav'
        },
        'backgroundColor': '#FFA500'
      },
      // triggered by force touch
      // TODO see https://developer.apple.com/library/ios/documentation/General/Conceptual/WatchKitProgrammingGuide/Menus.html#//apple_ref/doc/uid/TP40014969-CH15-SW1
      'contextMenu': {
        // configure up to 4 items (any more will be ignored)
        'items': [
          {
            'title': 'Play',
            //                     'image':'www/..',
            //                     'imageNamed':'',
            'iconNamed': 'play', // https://developer.apple.com/library/ios/documentation/WatchKit/Reference/WKInterfaceController_class/index.html#//apple_ref/doc/c_ref/WKMenuItemIcon
            'callback': 'onContextMenuPlay'
          },
          {
            'title': 'Resume',
            'iconNamed': 'resume',
            'callback': 'onContextMenuResume'
          }
        ]
      }
    };
    applewatch.sendMessage(payload);
  }

  function onContextMenuPlay() {
    feedback("Play");
  }

  function onContextMenuResume() {
    feedback("Resume");
  }

  function onContextMenuDelete() {
    feedback("Delete");
  }

  function onNotificationRegistrationSuccess(msg) {
    console.log("noti reg ok: " + msg);

    //we can now send a notification
    var payload = {
      "title": "Short!",
      "category": "default",
      "body": "Shown in the long-look interface to provide more detail",
      "badge": 0
    };

    //setTimeout(function() {
    //  applewatch.sendNotification(onNotificationSendSuccess, onNotificationSendError, payload);
    //}, 4000);
  }

  function onNotificationRegistrationError(msg) {
    alert("noti reg nok: " + msg);
  }

  function initAppleWatch() {
    applewatch.init(function (appGroupId) {
          // register for notifications
          //applewatch.registerNotifications(onNotificationRegistrationSuccess, onNotificationRegistrationError);
        },
        function (err) {
          // an error occurred
          alert("err: " + JSON.stringify(err));
        },
        // TODO dynamic
        "group.nl.xservices.applewatch"
    );
    applewatch.callback.onLoadAppMain = onAppRequestsUpdate;
    applewatch.callback.onLoadAppDetail = onAppDetailPageRequestsUpdate;
    applewatch.callback.onLoadGlance = onGlanceRequestsUpdate;
  }

  document.addEventListener('deviceready', function() {
    applewatch.callback.onError = function(message) {
      feedback("Error: " + message);
    };
    initAppleWatch();
  }, false);

</script>
</body>
</html>